import os
import asyncio
from datetime import datetime
from telegram import Update
from telegram.ext import (
    ApplicationBuilder,
    ChatMemberHandler,
    MessageHandler,
    ContextTypes,
    filters
)

VERIFY_MINUTES = 10

INTRO_TEMPLATE = (
    "æ˜µç§°ï¼š\n"
    "å¹´é¾„ï¼š\n"
    "æ¥è‡ªï¼š\n"
    "ç®€å•è‡ªæˆ‘ä»‹ç»ï¼š"
)

REQUIRED_KEYWORDS = ["æ˜µç§°", "å¹´é¾„", "æ¥è‡ª", "ä»‹ç»"]

pending_users = {}

async def new_member(update: Update, context: ContextTypes.DEFAULT_TYPE):
    for member in update.chat_member.new_chat_members:
        user_id = member.id
        chat_id = update.chat_member.chat.id

        pending_users[user_id] = {
            "chat_id": chat_id,
            "photo": False,
            "text_ok": False
        }

        welcome_text = (
            f"ğŸ‘‹ æ¬¢è¿ {member.full_name}\n\n"
            f"è¯·åœ¨ {VERIFY_MINUTES} åˆ†é’Ÿå†…å®ŒæˆéªŒè¯ï¼š\n\n"
            "ğŸ“¸ å‘é€ä¸€å¼ ç…§ç‰‡\n"
            "ğŸ“ å¤åˆ¶ä¸‹æ–¹æ¨¡æ¿å¡«å†™åå‘é€\n\n"
            "ğŸ‘‡ è¯·å¤åˆ¶ ğŸ‘‡\n"
            f"{INTRO_TEMPLATE}\n\n"
            "âŒ è¶…æ—¶å°†è¢«ç§»å‡ºç¾¤"
        )

        await context.bot.send_message(chat_id=chat_id, text=welcome_text)
        asyncio.create_task(verification_timer(context, user_id))

async def check_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    msg = update.message
    if not user or user.id not in pending_users:
        return

    data = pending_users[user.id]

    if msg.photo:
        data["photo"] = True

    text = msg.text or msg.caption or ""
    if all(k in text for k in REQUIRED_KEYWORDS):
        data["text_ok"] = True

    if data["photo"] and data["text_ok"]:
        pending_users.pop(user.id, None)
        await msg.reply_text("âœ… éªŒè¯æˆåŠŸï¼Œæ¬¢è¿åŠ å…¥ï¼ğŸ‰")

async def verification_timer(context, user_id):
    await asyncio.sleep(VERIFY_MINUTES * 60)
    if user_id in pending_users:
        chat_id = pending_users[user_id]["chat_id"]
        try:
            await context.bot.send_message(
                chat_id=user_id,
                text="âš ï¸ ä½ æœªå®ŒæˆéªŒè¯ï¼Œå·²è¢«ç§»å‡ºç¾¤ã€‚"
            )
        except:
            pass
        await context.bot.ban_chat_member(chat_id, user_id)
        pending_users.pop(user_id, None)

def main():
    app = ApplicationBuilder().token(os.getenv("BOT_TOKEN")).build()
    app.add_handler(ChatMemberHandler(new_member, ChatMemberHandler.CHAT_MEMBER))
    app.add_handler(MessageHandler(filters.ALL, check_message))
    print("ğŸ¤– Bot å·²å¯åŠ¨")
    app.run_polling()

if __name__ == "__main__":
    main()
